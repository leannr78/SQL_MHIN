drop program MHIN_COMMVIEW_AUDIT go
create program MHIN_COMMVIEW_AUDIT

prompt 
	"Output to File/Printer/MINE" = "MINE"   ;* Enter or select the printer or file name to send this report to.
	, "Organization" = ""
	, "Enter Start Date" = "SYSDATE"
	, "Enter End Date" = "SYSDATE" 

with OUTDEV, ORG, startdate, enddate
	
	
	SET BEGIN_DT = CNVTDATETIME($StartDate)
	SET END_DT = CNVTDATETIME($EndDate)


; I commented out the output prompt
;Request HNAM sign-on when executed from CCL on host
IF (VALIDATE(IsOdbc, 0) = 0)  EXECUTE CCLSECLOGIN  ENDIF
  
SET MaxSecs = 0

IF (VALIDATE(IsOdbc, 0) = 1)  SET MaxSecs = 15  ENDIF

SELECT	INTO $OUTDEV 
	NAME_PT_LAST = SUBSTRING
	(1,40,PE.NAME_LAST),
	NAME__PT_FIRST = SUBSTRING
	(1,15,PE.NAME_FIRST),
	DR_LAST = SUBSTRING
	(1,40,P.NAME_LAST),
	DR_FIRST = SUBSTRING
	(1,15,P.NAME_FIRST),
	POSITION = SUBSTRING
	(1,25,UAR_GET_CODE_DISPLAY( P.POSITION_CD )),
	RELATIONSHIP = SUBSTRING
	(1,25,UAR_GET_CODE_DISPLAY( E.ENCNTR_PRSNL_R_CD )),
	MANUAL_DT =	format
	(E.MANUAL_CREATE_DT_TM, "MM/DD/YYYY;;D"),
	FACILITY_DISP =	SUBSTRING
	(1,10,UAR_GET_CODE_DISPLAY( EN.LOC_FACILITY_CD )),
	FLOOR= SUBSTRING
	(1,10,UAR_GET_CODE_DISPLAY( EN.LOC_NURSE_UNIT_CD )),
	ROOM = SUBSTRING
	(1,5,UAR_GET_CODE_DISPLAY( EN.LOC_ROOM_CD )),
	REG_DATE = format (EN.REG_DT_TM, "MM/DD/YYYY;;D"),
	DC_DT = format (EN.DISCH_DT_TM, "MM/DD/YYYY;;D")
 
FROM PRSNL  P,
	ENCNTR_PRSNL_RELTN  E,
	ENCOUNTER  EN,
	PERSON  PE
 
PLAN  P WHERE  P.ACTIVE_IND = 1  
 
JOIN  E 
	WHERE E.MANUAL_CREATE_DT_TM BETWEEN BEGIN_DT AND END_DT
	AND  E.MANUAL_CREATE_BY_ID =  P.PERSON_ID
JOIN  EN 
	WHERE  EN.ENCNTR_ID =  E.ENCNTR_ID
JOIN  PE 
	WHERE  PE.PERSON_ID =  EN.PERSON_ID
WITH  TIME = VALUE( MaxSecs );, SEPARATOR = ",", FORMAT
 
END
GO

